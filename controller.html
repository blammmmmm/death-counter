<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Death Counter Controller</title>
  <style>
    :root{ --green:#9cff57; }
    body{
      margin:0; padding:22px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#0b0f0b; color:var(--green);
    }
    .card{
      max-width:520px;
      border:1px solid rgba(156,255,87,.25);
      border-radius:14px;
      padding:18px;
      box-shadow: 0 0 24px rgba(156,255,87,.08);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button, input{
      border-radius:12px;
      border:1px solid rgba(156,255,87,.25);
      background: rgba(156,255,87,.06);
      color:var(--green);
      padding:12px 14px;
      font-size:16px;
    }
    button{ cursor:pointer; }
    button:hover{ background: rgba(156,255,87,.12); }
    .big{ font-size:20px; font-weight:800; }
    .muted{ opacity:.75; font-size:13px; margin-top:8px; line-height:1.4; }
    .count{ font-size:44px; font-weight:900; margin-top:10px; }
    .danger{ border-color: rgba(255,87,87,.35); color:#ff9a9a; background: rgba(255,87,87,.06); }
    .danger:hover{ background: rgba(255,87,87,.12); }
    input{ width:160px; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border:1px solid rgba(156,255,87,.25);
      border-radius:999px;
      margin-top:10px;
      font-size:12px;
      opacity:.9;
    }
    .err{ margin-top:10px; font-size:12px; color:#ff9a9a; display:none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="big">DEATH COUNTER CONTROLLER</div>
    <div class="pill" id="tag"></div>

    <div class="count" id="count">0</div>

    <div class="row">
      <button id="plus">+1 Death</button>
      <button id="minus">-1 Undo</button>
      <button class="danger" id="reset">Reset</button>
    </div>

    <div class="row">
      <input id="setInput" type="number" min="0" step="1" placeholder="Set toâ€¦" />
      <button id="setBtn">Set</button>
    </div>

    <div class="err" id="err"></div>

    <div class="muted">
      Works from phone/mod PC. Uses Firebase RTDB:
      <span style="opacity:.9">/rooms/&lt;room&gt;/deaths</span>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const params = new URLSearchParams(location.search);
    const dbUrl = params.get("db");
    const room = params.get("room") || "main";

    const tag = document.getElementById("tag");
    const countEl = document.getElementById("count");
    const errEl = document.getElementById("err");
    tag.textContent = `room=${room}`;

    function showErr(msg){
      errEl.style.display = "block";
      errEl.textContent = msg;
    }

    if (!dbUrl) {
      showErr("Missing ?db=YOUR_FIREBASE_RTD_B_URL");
      throw new Error("Missing db param");
    }

    firebase.initializeApp({ databaseURL: dbUrl });

    const ref = firebase.database().ref(`rooms/${room}/deaths`);

    // live display
    ref.on("value", (snap) => {
      const v = Number(snap.val());
      countEl.textContent = String(Number.isFinite(v) ? Math.max(0, Math.floor(v)) : 0);
    }, (err) => showErr("Listen error: " + (err?.message || String(err))));

    // atomic increment/decrement (prevents race if multiple mods click)
    function add(delta){
      ref.transaction((cur) => {
        const n = Number(cur);
        const safe = Number.isFinite(n) ? n : 0;
        return Math.max(0, Math.floor(safe + delta));
      });
    }

    document.getElementById("plus").onclick = () => add(1);
    document.getElementById("minus").onclick = () => add(-1);

    document.getElementById("setBtn").onclick = async () => {
      const val = Number(document.getElementById("setInput").value);
      if (!Number.isFinite(val)) return;
      await ref.set(Math.max(0, Math.floor(val)));
    };

    document.getElementById("reset").onclick = async () => {
      const ok = prompt("Type RESET to confirm reset:");
      if (ok === "RESET") await ref.set(0);
    };
  </script>
</body>
</html>
